#!/usr/bin/env python3
# -*- coding: utf-8 -*-

import numpy as np
import pandas as pd
import matplotlib.pyplot as plt
from sklearn.model_selection import KFold
from sklearn.model_selection import train_test_split
from sklearn.linear_model import LinearRegression
from sklearn.linear_model import Lasso

# import Data

fillonData = pd.read_csv('fillonData.csv', encoding='latin-1')
hamonData = pd.read_csv('hamonData.csv', encoding='latin-1')
lepenData = pd.read_csv('lepenData.csv', encoding='latin-1')
macronData = pd.read_csv('macronData.csv', encoding='latin-1')
melenchonData = pd.read_csv('melenchonData.csv', encoding='latin-1')
cantonsData = pd.read_csv('cantonsData.csv', encoding='latin-1')

# create a dictionary -> key : department, attribute : number of cantons)

listDepartements = list(cantonsData['Code du département'])
listCantons = list(cantonsData['Code du canton'])

dicoCanton = {}
i = 0
departement = listDepartements[0]
canton = 0
while i < len(listDepartements):
    if listDepartements[i]==departement:
        canton += 1
    else :
        dicoCanton[departement] = canton
        departement = listDepartements[i]
        canton = listCantons[i]
    i += 1
dicoCanton[departement]=canton
# =============================================================================
#
# print(dicoCanton)
# {'1': 23, '2': 21, '3': 19, '4': 15, '5': 15, '6': 27, '7': 17, '8': 19, '9': 13, '10': 17, '11': 19, '12': 23, '13': 29, '14': 25, '15': 15, '16': 19, '17': 27, '18': 19, '19': 19, '2A': 11, '2B': 15, '21': 23, '22': 27, '23': 15, '24': 25, '25': 19, '26': 19, '27': 23, '28': 15, '29': 27, '30': 23, '31': 27, '32': 17, '33': 33, '34': 25, '35': 27, '36': 13, '37': 19, '38': 29, '39': 17, '40': 15, '41': 15, '42': 21, '43': 19, '44': 31, '45': 21, '46': 17, '47': 21, '48': 13, '49': 21, '50': 27, '51': 23, '52': 17, '53': 17, '54': 23, '55': 17, '56': 21, '57': 27, '58': 17, '59': 41, '60': 21, '61': 21, '62': 39, '63': 31, '64': 27, '65': 17, '66': 17, '67': 23, '68': 17, '69': 14, '70': 17, '71': 29, '72': 21, '73': 19, '74': 17, '75': 34, '76': 35, '77': 23, '78': 21, '79': 17, '80': 23, '81': 23, '82': 15, '83': 23, '84': 17, '85': 17, '86': 19, '87': 21, '88': 17, '89': 21, '90': 9, '91': 21, '92': 23, '93': 21, '94': 25, '95': 21, 'ZA': 21, 'ZB': 1, 'ZC': 1, 'ZD': 25, 'ZM': 13, 'ZN': 3, 'ZP': 6, 'ZS': 1, 'ZW': 1, 'ZX': 1, 'ZZ': 1}
#     
# =============================================================================


# linear regression algorithm


def linearRegression_v1(X_train,y_train,X_test):
    reg = LinearRegression().fit(X_train, y_train)
    print(reg.score(X_train,y_train))
    return(reg.predict(X_test))

def linearRegression_v2(X_train,y_train,X_test):
    reg = Lasso().fit(X_train, y_train)
    print(reg.score(X_train,y_train))
    return(reg.predict(X_test))
    
# =============================================================================
# plt.plot(fillonData['% Voix/Exp'], fillonData['Médiane du niveau vie en 2015'], 'ro', markersize=1)
# # plt.show()
# 
# 
# X = np.matrix([np.ones(fillonData.shape[0]), fillonData['Médiane du niveau vie en 2015'].as_matrix()]).T
# y = np.matrix(fillonData['% Voix/Exp']).T
# 
# theta = np.linalg.inv(X.T.dot(X)).dot(X.T).dot(y)
# 
# plt.plot([0,1], [theta.item(0),theta.item(0) + theta.item(1)])
#
# =============================================================================



# cross validation algorithm

def crossValidation(data,algo,nb_folds):
    
    newData = []	
    for row in data:
        newData.append(row[0:])
        X = np.array(data)
    y = X[:,X.shape[1]-1]           # '% Voix/Exp' is the last column
    X = np.delete(X,X.shape[1]-1,1)
    X = np.delete(X,X.shape[1]-1,1)
    X = np.delete(X,X.shape[1]-1,1)
    
#    list_var=data.columns.drop('% Voix/Exp')
#    X=data[list_var]
#    y=data['% Voix/Exp']
#    print(X,y)
    
    kf = KFold(n_splits=nb_folds, shuffle=True)
    
    totalInstances = 0
    totalGap = 0
#    totalCorrect = 0
    
    
    for train_index, test_index in kf.split(fillonData):
        # print("train : ", train_index, "test : ", test_index)
        X_train = X[train_index]
        X_test = X[test_index]
        y_train = y[train_index]
        y_test = y[test_index]

        y_predicted = algo(X_train, y_train, X_test)
        
        gap = 0	
        for i in range(y_test.size):
#            if y_predicted[i] > y_test[i]-0.02 and y_predicted[i] < y_test[i]+0.02:
#                correct += 1
            gap += np.abs(y_predicted[i]-y_test[i])
            
        print ('gap :',str(gap/y_test.size*100),'%')
        totalGap += gap
        totalInstances += y_test.size
    print ('total success : ',str(totalGap/totalInstances*100),'%')